<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura Y√∂netim Paneli</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { --primary: #1a0f0a; --accent: #bc6c25; --success: #2e7d32; --bg: #f8f5f2; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .section { background: white; border-radius: 16px; padding: 24px; margin-bottom: 30px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); }
        h2 { color: var(--primary); font-weight: 700; margin-bottom: 20px; border-bottom: 3px solid var(--accent); padding-bottom: 12px; }
        .kasa-input { width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 12px; font-size: 1.1rem; margin-bottom: 20px; box-sizing: border-box; }
        .kasa-input:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(188,108,37,0.2); }
        .satir { display: flex; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid #eee; }
        .toplam-bar { background: var(--primary); color: white; padding: 18px; border-radius: 12px; display: flex; justify-content: space-between; font-size: 1.3rem; font-weight: 700; margin: 20px 0; }
        .btn-kapat { background: var(--success); color: white; border: none; padding: 18px; width: 100%; border-radius: 12px; font-size: 1.2rem; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn-kapat:hover { background: #1b5e20; }
        .card { background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
        .masa-no { background: var(--accent); color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; }
        .btn-teslim { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="section">
        <h2>üë®‚Äçüç≥ Hazƒ±rlanan Sipari≈üler</h2>
        <div id="mutfak-liste"></div>
    </div>

    <div class="section" style="max-width: 600px; margin: 0 auto;">
        <h2>üí∞ Kasa / Masa √ñdeme</h2>
        <input type="text" id="kasaMasaInput" class="kasa-input" placeholder="Masa Numarasƒ± (√∂rn: 8)" oninput="kasaGuncelle()">
        
        <div id="kasa-detay">
            <p style="text-align:center; color:#666;">Masa se√ßilmedi.</p>
        </div>

        <div class="toplam-bar">
            <span>GENEL TOPLAM</span>
            <span id="genel-toplam">0 TL</span>
        </div>
        <button class="btn-kapat" onclick="odemeAl()">√ñDEME ALINDI & MASAYI BO≈ûALT</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAO2RemuvkZuYHUoKqYCkxLGpkhZNXdcKQ",
            authDomain: "aurasiparis-27cef.firebaseapp.com",
            databaseURL: "https://aurasiparis-27cef-default-rtdb.firebaseio.com",
            projectId: "aurasiparis-27cef",
            storageBucket: "aurasiparis-27cef.firebasestorage.app",
            messagingSenderId: "90780214645",
            appId: "1:90780214645:web:601547318ff44ea9869f3c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // MUTFAK Lƒ∞STESƒ∞ G√úNCELLEME
        db.ref('siparisler').on('value', (snapshot) => {
            const mutfakListe = document.getElementById('mutfak-liste');
            mutfakListe.innerHTML = "";
            snapshot.forEach((child) => {
                const s = child.val();
                if (s.durum === "Yeni") {
                    mutfakListe.innerHTML += `
                        <div class="card">
                            <div>
                                <span class="masa-no">MASA ${s.masa}</span>
                                <strong>${s.urun}</strong>
                            </div>
                            <button class="btn-teslim" onclick="teslimEt('${child.key}')">TESLƒ∞M ET</button>
                        </div>`;
                }
            });
            kasaGuncelle();
        });

        function teslimEt(id) {
            db.ref('siparisler/' + id).update({ durum: "Teslim Edildi" });
        }

        function kasaGuncelle() {
            let masaNo = document.getElementById('kasaMasaInput').value.trim();
            if (!masaNo) {
                document.getElementById('kasa-detay').innerHTML = "<p style='text-align:center; color:#666;'>Masa numarasƒ± girin.</p>";
                document.getElementById('genel-toplam').innerText = "0 TL";
                return;
            }
            
            db.ref('siparisler').orderByChild('masa').equalTo(masaNo).once('value', (snapshot) => {
                let toplam = 0;
                let html = "";
                snapshot.forEach((child) => {
                    const s = child.val();
                    toplam += Number(s.fiyat || 0);
                    const ikon = s.durum === "Yeni" ? "‚è≥" : "‚úÖ";
                    html += `<div class="satir"><span>${ikon} ${s.urun}</span><strong>${s.fiyat} TL</strong></div>`;
                });
                document.getElementById('kasa-detay').innerHTML = html || "<p style='text-align:center; color:#666;'>Bu masada aktif sipari≈ü yok.</p>";
                document.getElementById('genel-toplam').innerText = toplam + " TL";
            });
        }

        // --- MASAYI SIFIRLAYAN ANA FONKSƒ∞YON ---
        function odemeAl() {
            let masaNo = document.getElementById('kasaMasaInput').value.trim();
            if (!masaNo) return alert("Masa numarasƒ± girmediniz!");

            if (confirm(`Masa ${masaNo} √∂demesi alƒ±ndƒ± ve masa bo≈üaltƒ±lƒ±yor. Onaylƒ±yor musunuz?`)) {
                // 1. O masaya ait t√ºm sipari≈üleri Firebase'den tamamen sil
                db.ref('siparisler').orderByChild('masa').equalTo(masaNo).once('value', (snapshot) => {
                    if (!snapshot.exists()) {
                        alert("Bu masada silinecek sipari≈ü bulunamadƒ±.");
                        return;
                    }

                    let silmeIslemleri = [];
                    snapshot.forEach((child) => {
                        silmeIslemleri.push(db.ref('siparisler/' + child.key).remove());
                    });

                    // 2. Sipari≈üler silindikten sonra masayƒ± sƒ±fƒ±rla
                    Promise.all(silmeIslemleri).then(() => {
                        return db.ref('masalar/' + masaNo).remove(); // Varsa masa kilit verisini de siler
                    })
                    .then(() => {
                        alert(`Masa ${masaNo} sƒ±fƒ±rlandƒ±. Yeni m√º≈üteri i√ßin hazƒ±r!`);
                        document.getElementById('kasaMasaInput').value = "";
                        kasaGuncelle();
                    })
                    .catch(err => alert("Hata olu≈ütu: " + err.message));
                });
            }
        }
    </script>
</body>
</html>
